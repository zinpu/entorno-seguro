
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dif ‚Ä¢ Comparador Agentes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: #111418;
        color: white;
      }
      
      /* Custom Scrollbar for dark theme */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1A1E23; 
      }
      ::-webkit-scrollbar-thumb {
        background: #2A2F36; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #3A4048; 
      }

      /* Animation utilities */
      .animate-fade-in { animation: fadeIn 0.6s ease-out; }
      .animate-slide-up { animation: slideInUp 0.4s ease-out; }
      
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
      
      /* Utility classes not in Tailwind defaults */
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Eye, EyeOff, Edit2, Link as LinkIcon, Download, Copy, Maximize2, Minimize2 
      } from 'lucide-react';

      /* --- UTILS --- */
      
      const parseAmountRaw = (raw) => {
        if (raw === null || raw === undefined) return 0;
        let s = String(raw).trim();
        if (!s) return 0;
        s = s.replace(/[^\d,\.-]/g, '');
        if (s.includes(',')) {
          s = s.replace(/\./g, '').replace(',', '.');
        }
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
      };

      const parseCSVLine = (line, delimiter = ',') => {
        const out = [];
        let cur = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              cur += '"';
              i++;
              continue;
            }
            inQuotes = !inQuotes;
            continue;
          }
          if (ch === delimiter && !inQuotes) {
            out.push(cur);
            cur = '';
            continue;
          }
          cur += ch;
        }
        out.push(cur);
        return out;
      };

      const getTurnoFromDate = (d) => {
        if (!d || isNaN(d.getTime())) return '';
        const h = d.getHours();
        if (h >= 6 && h < 14) return 'TM';
        if (h >= 14 && h < 22) return 'TT';
        return 'TN';
      };

      const parseAgentLines = (lines, labelA) => {
        const rows = [];
        let startIndex = 0;
        let format = null;

        if (lines.length === 0) return rows;
        if (lines[0].toLowerCase().startsWith('sep=')) startIndex = 1;
        
        const headerLine = lines[startIndex];
        if (headerLine) {
          const headerCols = parseCSVLine(headerLine);
          if (headerCols[3]?.toLowerCase() === 'cantidad' && headerCols[6]?.toLowerCase() === 'alias del jugador') {
            format = 'sub';
          } else if (headerCols[2]?.toLowerCase() === 'cantidad' && headerCols[4]?.toLowerCase() === 'alias') {
            format = 'main';
          } else {
            console.warn(`No se pudo determinar el formato CSV para ${labelA}, se omite archivo.`);
            return rows;
          }
          startIndex++;
        }

        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim() || !line.includes(',')) continue;
          const cols = parseCSVLine(line);
          if (cols.length < 5) continue;

          const fechaRaw = (cols[0] || '').trim();
          let montoRaw, usuarioRaw, tipoRaw;

          if (format === 'sub') {
            montoRaw = cols[3];
            usuarioRaw = cols[6];
            tipoRaw = cols[1];
          } else {
            montoRaw = cols[2];
            usuarioRaw = cols[4];
            tipoRaw = cols[3];
          }

          const monto = parseAmountRaw(montoRaw);
          const usuario = (usuarioRaw || '').toLowerCase().trim();
          const isAdminCharge = /te cargaron|ajuste/i.test(tipoRaw || '');

          let fechaObj = null;
          if (fechaRaw) {
            const attempt = new Date(fechaRaw.replace(' ', 'T'));
            fechaObj = isNaN(attempt.getTime()) ? new Date(fechaRaw) : attempt;
            if (isNaN(fechaObj.getTime())) fechaObj = null;
          }

          rows.push({
            origen: 'A',
            etiqueta: labelA,
            fecha: fechaRaw,
            fechaObj,
            monto,
            usuario,
            isAdminCharge
          });
        }
        return rows;
      };

      const parseBLines = (lines) => {
        const rows = [];
        for (let raw of lines) {
          if (!raw.trim()) continue;
          let parts = raw.split(/\t+/).map(p => p.trim()).filter(Boolean);
          if (parts.length < 2) {
            parts = raw.split(/\s{2,}/).map(p => p.trim()).filter(Boolean);
          }
          if (parts.length > 0 && /^\d{7,}$/.test(parts[0])) {
            parts.shift();
          }
          if (parts.length >= 2 && /^\d{2}-\d{2}-\d{4}$/.test(parts[0]) && /^\d{2}:\d{2}:\d{2}$/.test(parts[1])) {
            parts[0] = parts[0] + ' ' + parts[1];
            parts.splice(1, 1);
          }

          if (parts.length < 4) continue;

          let [fechaRaw, operador, medioRaw, montoRaw, usuarioRaw] = parts;
          let medio = (medioRaw || '').replace(/.*-\s*/, '').trim();
          if (!medio) medio = (medioRaw || '').trim();
          const monto = parseAmountRaw(montoRaw);
          const usuario = (usuarioRaw || '').toLowerCase().trim();
          
          let fechaObj = null;
          if (fechaRaw) {
            const m = fechaRaw.match(/(\d{2})-(\d{2})-(\d{4})\s+(\d{2}:\d{2}:\d{2})/);
            if (m) {
              fechaObj = new Date(`${m[3]}-${m[2]}-${m[1]}T${m[4]}`);
            } else {
              const attempt = new Date(fechaRaw.replace(' ', 'T'));
              if (!isNaN(attempt.getTime())) fechaObj = attempt;
            }
          }

          rows.push({
            origen: 'B',
            fecha: fechaRaw,
            fechaObj,
            monto,
            usuario,
            operador: (operador || '').toLowerCase().trim(),
            medio: (medio || '').toUpperCase().trim()
          });
        }
        return rows;
      };

      const formatCurrency = (val) => {
        return val.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      };

      const formatTime = (d) => {
        if (!d || isNaN(d.getTime())) return '';
        const pad = (num) => num.toString().padStart(2, '0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      };

      const formatDateStr = (d) => {
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      };

      /* --- COMPONENTS: MODALS --- */

      const EditModal = ({ isOpen, pair, onClose, onSave }) => {
        const [formData, setFormData] = useState({
          aUser: '', aMonto: '0', aBilletera: '',
          bUser: '', bMonto: '0', bBilletera: ''
        });

        useEffect(() => {
          if (pair) {
            setFormData({
              aUser: pair.a?.usuario || '',
              aMonto: pair.a?.monto?.toString() || '0',
              aBilletera: '',
              bUser: pair.b?.usuario || '',
              bMonto: pair.b?.monto?.toString() || '0',
              bBilletera: pair.b?.medio || ''
            });
          }
        }, [pair]);

        if (!isOpen || !pair) return null;

        const handleSave = () => {
          const updated = { ...pair };
          
          // L√≥gica para actualizar o crear Agente (A)
          if (formData.aUser || parseFloat(formData.aMonto) !== 0) {
            if (!updated.a) {
              // Si no exist√≠a A, lo creamos
              updated.a = {
                origen: 'A',
                etiqueta: 'MANUAL',
                fecha: updated.b?.fecha || '',
                fechaObj: updated.b?.fechaObj || new Date(),
                isAdminCharge: false,
                turno: updated.b?.turno || ''
              };
            }
            updated.a.usuario = formData.aUser;
            updated.a.monto = parseFloat(formData.aMonto);
          }

          // L√≥gica para actualizar o crear Chunior (B)
          if (formData.bUser || parseFloat(formData.bMonto) !== 0 || formData.bBilletera) {
            if (!updated.b) {
              // Si no exist√≠a B, lo creamos
              updated.b = {
                origen: 'B',
                operador: 'MANUAL',
                fecha: updated.a?.fecha || '',
                fechaObj: updated.a?.fechaObj || new Date(),
                turno: updated.a?.turno || ''
              };
            }
            updated.b.usuario = formData.bUser;
            updated.b.monto = parseFloat(formData.bMonto);
            updated.b.medio = formData.bBilletera;
          }

          // Si ahora tenemos ambos lados, cambiamos estado a MANUAL (emparejado)
          if (updated.a && updated.b) {
            updated.estado = 'MANUAL';
            // Recalculamos tipoMovimiento si es necesario, basado en A
            updated.tipoMovimiento = updated.a.monto < 0 ? 'EGRESO' : 'INGRESO';
          }

          onSave(updated);
        };

        const inputClass = "w-full bg-[#1E2329] border border-[#2A2A2A] rounded p-2 text-white focus:border-[#C7F24A] focus:outline-none mb-4 disabled:opacity-50 disabled:cursor-not-allowed";
        const labelClass = "block text-xs text-[#A8A8A8] mb-1 uppercase font-semibold";

        return (
          <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] backdrop-blur-sm animate-fade-in">
            <div className="bg-[#1A1E23] border border-[#2A2A2A] rounded-xl p-6 w-full max-w-lg shadow-2xl animate-slide-up">
              <h2 className="text-xl font-bold text-white mb-4 border-b border-[#2A2A2A] pb-2">‚úèÔ∏è Editar movimiento</h2>
              <p className="text-xs text-[#777] mb-4">Puedes completar los datos faltantes para conciliar manualmente.</p>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <h3 className="text-[#C7F24A] text-sm font-bold mb-3 flex items-center gap-2">
                    Datos Agente
                    {!pair.a && <span className="text-[10px] bg-[#2A2F36] px-1 rounded text-[#AAA]">FALTA</span>}
                  </h3>
                  <label className={labelClass}>Usuario</label>
                  <input className={inputClass} value={formData.aUser} onChange={e => setFormData({...formData, aUser: e.target.value})} />
                  
                  <label className={labelClass}>Monto</label>
                  <input type="number" className={inputClass} value={formData.aMonto} onChange={e => setFormData({...formData, aMonto: e.target.value})} />
                </div>

                <div>
                  <h3 className="text-[#7A5CFF] text-sm font-bold mb-3 flex items-center gap-2">
                    Datos Chunior
                    {!pair.b && <span className="text-[10px] bg-[#2A2F36] px-1 rounded text-[#AAA]">FALTA</span>}
                  </h3>
                  <label className={labelClass}>Usuario</label>
                  <input className={inputClass} value={formData.bUser} onChange={e => setFormData({...formData, bUser: e.target.value})} />
                  
                  <label className={labelClass}>Monto</label>
                  <input type="number" className={inputClass} value={formData.bMonto} onChange={e => setFormData({...formData, bMonto: e.target.value})} />
                  
                  <label className={labelClass}>Billetera</label>
                  <input className={inputClass} value={formData.bBilletera} onChange={e => setFormData({...formData, bBilletera: e.target.value})} />
                </div>
              </div>

              <div className="flex justify-end gap-3 mt-4 pt-4 border-t border-[#2A2A2A]">
                <button onClick={onClose} className="px-4 py-2 rounded-lg bg-[#2A2F36] text-[#A8A8A8] hover:text-white transition-colors">Cancelar</button>
                <button onClick={handleSave} className="px-4 py-2 rounded-lg bg-gradient-to-r from-[#C7F24A] to-[#D4FF4A] text-[#0D1117] font-bold shadow-lg shadow-[#C7F24A]/20 hover:translate-y-[-2px] transition-transform">Guardar</button>
              </div>
            </div>
          </div>
        );
      };

      const LinkModal = ({ isOpen, basePair, allPairs, onClose, onLink }) => {
        if (!isOpen || !basePair) return null;

        const isLookingForB = !!basePair.a;
        
        const candidates = allPairs.filter(p => {
          if (p.id === basePair.id) return false;
          if (p.estado === 'OK' || p.estado === 'MANUAL') return false; 
          if (isLookingForB) return !!p.b && !p.a;
          return !!p.a && !p.b;
        });

        return (
          <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] backdrop-blur-sm animate-fade-in">
            <div className="bg-[#1A1E23] border border-[#2A2A2A] rounded-xl p-6 w-full max-w-lg shadow-2xl animate-slide-up flex flex-col max-h-[80vh]">
              <h2 className="text-xl font-bold text-white mb-2">üîó Enlazar movimiento</h2>
              <p className="text-[#A8A8A8] text-sm mb-4">Seleccion√° un movimiento hu√©rfano para unirlo con el actual.</p>

              <div className="overflow-y-auto flex-1 space-y-2 pr-2 custom-scrollbar">
                {candidates.length === 0 ? (
                  <div className="text-center p-4 text-[#A8A8A8] italic">No hay candidatos disponibles para enlazar.</div>
                ) : (
                  candidates.map(c => {
                    const displayUser = c.a?.usuario || c.b?.usuario;
                    const displayMonto = c.a?.monto ?? c.b?.monto;
                    const displayTime = c.a?.fecha?.split(' ')[1] || c.b?.fecha?.split(' ')[1];
                    
                    return (
                      <button 
                        key={c.id}
                        onClick={() => onLink(basePair.id, c.id)}
                        className="w-full text-left p-3 rounded bg-[#1E2329] border border-[#2A2A2A] hover:border-[#7A5CFF] hover:bg-[#242930] transition-all flex justify-between items-center group"
                      >
                        <div>
                          <div className="font-bold text-white group-hover:text-[#7A5CFF]">{displayUser}</div>
                          <div className="text-xs text-[#777]">{displayTime || 'Unknown Time'}</div>
                        </div>
                        <div className={`font-mono font-bold ${(displayMonto || 0) < 0 ? 'text-[#EF4444]' : 'text-[#9EE759]'}`}>
                          $ {(displayMonto || 0).toLocaleString('es-AR', {minimumFractionDigits: 2})}
                        </div>
                      </button>
                    );
                  })
                )}
              </div>

              <div className="flex justify-end mt-4 pt-4 border-t border-[#2A2A2A]">
                <button onClick={onClose} className="px-4 py-2 rounded-lg bg-[#2A2F36] text-[#A8A8A8] hover:text-white transition-colors">Cerrar</button>
              </div>
            </div>
          </div>
        );
      };

      const SummaryBadge = ({ label, value, type }) => {
        let color = "text-white";
        if (type === 'diff') color = value === 0 ? "text-[#9EE759]" : (value > 0 ? "text-[#9EE759]" : "text-[#EF4444]");
        if (type === 'warn') color = "text-[#F59E0B]";
        if (type === 'bad') color = "text-[#EF4444]";
        if (type === 'neutral') color = "text-[#9EE759]";

        return (
          <div className={`flex flex-col items-center justify-center p-3 rounded-lg bg-[#1E2329] border border-[#2A2A2A] ${type === 'diff' && Math.abs(value) > 0.01 ? 'border-[#EF4444]/30 bg-[#EF4444]/5' : ''}`}>
            <span className="text-xs text-[#A8A8A8] uppercase font-semibold">{label}</span>
            <strong className={`text-lg mt-1 ${color}`}>{formatCurrency(value)}</strong>
          </div>
        );
      };

      const CompactSummaryBadge = ({ label, value, type }) => {
        let color = "text-white";
        if (type === 'diff') color = value === 0 ? "text-[#9EE759]" : (value > 0 ? "text-[#9EE759]" : "text-[#EF4444]");
        if (type === 'warn') color = "text-[#F59E0B]";
        if (type === 'bad') color = "text-[#EF4444]";
        if (type === 'neutral') color = "text-[#9EE759]";

        return (
          <div className="flex items-center gap-2 px-3 py-1 bg-[#2A2F36] rounded border border-[#2A2A2A] shrink-0">
            <span className="text-[10px] text-[#AAA] uppercase font-bold">{label}:</span>
            <span className={`text-xs font-bold font-mono ${color}`}>{formatCurrency(value)}</span>
          </div>
        );
      };

      const SelectFilter = ({ label, value, options, onChange }) => {
        return (
          <div className="flex flex-col">
            <label className="text-[11px] text-[#777] font-bold uppercase mb-1">{label}</label>
            <div className="relative">
              <select 
                value={value} 
                onChange={e => onChange(e.target.value)}
                className="w-full bg-[#1E2329]/80 border border-[#2A2A2A] text-[#DDD] text-xs rounded p-2 pr-6 appearance-none focus:border-[#24364A] focus:outline-none cursor-pointer hover:bg-[#242930] transition-colors"
              >
                <option value="__ALL">Todos</option>
                {options.map(o => <option key={o} value={o}>{o}</option>)}
              </select>
              <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-[#555] text-[10px]">‚ñº</div>
            </div>
          </div>
        );
      };

      /* --- APP COMPONENT --- */

      function App() {
        const [agentFiles, setAgentFiles] = useState(null);
        const [chuniorText, setChuniorText] = useState('');
        const [pairs, setPairs] = useState([]);
        const [isProcessing, setIsProcessing] = useState(false);
        const [ignoredIds, setIgnoredIds] = useState(new Set());
        const [tableFullscreen, setTableFullscreen] = useState(false);
        
        // Modal State
        const [editModalOpen, setEditModalOpen] = useState(false);
        const [editingPair, setEditingPair] = useState(null);
        
        const [linkModalOpen, setLinkModalOpen] = useState(false);
        const [linkingBasePair, setLinkingBasePair] = useState(null);

        // Filters
        const [filters, setFilters] = useState({
          fecha: '__ALL',
          agente: '__ALL',
          operador: '__ALL',
          billetera: '__ALL',
          turno: '__ALL',
          estado: '__ALL',
          movimiento: '__ALL'
        });

        // Listen for ESC to exit focus mode
        useEffect(() => {
          const handleKeyDown = (e) => {
            if (e.key === 'Escape' && tableFullscreen) {
              setTableFullscreen(false);
            }
          };
          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }, [tableFullscreen]);

        // Processing Logic
        const processData = async () => {
          setIsProcessing(true);
          setIgnoredIds(new Set());
          
          await new Promise(r => setTimeout(r, 100));

          let rowsA = [];
          
          try {
            if (agentFiles && agentFiles.length) {
              for (let i = 0; i < agentFiles.length; i++) {
                const f = agentFiles[i];
                const text = await f.text();
                const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l => l.trim() !== '');
                const labelMatch = f.name.match(/(agente|subagente|fuente|a)_?([a-zA-Z0-9]+)/i);
                const labelA = labelMatch?.[2]?.toLowerCase() || f.name.replace(/\.csv$/i, '');
                
                rowsA = rowsA.concat(parseAgentLines(lines, labelA));
              }
            }
          } catch (e) {
            alert('Error leyendo archivos de Agente: ' + e.message);
            setIsProcessing(false);
            return;
          }

          const rowsB = parseBLines(chuniorText.split(/\r?\n/).filter(l => l.trim() !== ''));

          // Augment data
          rowsA.forEach(r => { 
            r.turno = r.fechaObj ? getTurnoFromDate(r.fechaObj) : ''; 
            r.tipoMovimiento = r.monto < 0 ? 'EGRESO' : 'INGRESO'; 
          });
          rowsB.forEach(r => { 
            r.turno = r.fechaObj ? getTurnoFromDate(r.fechaObj) : ''; 
            r.tipoMovimiento = r.monto < 0 ? 'EGRESO' : 'INGRESO'; 
          });

          const newPairs = [];
          const matchedBIdx = new Set();
          let idCounter = 0;

          // Match A to B
          rowsA.forEach(a => {
            if (a.isAdminCharge) {
              newPairs.push({ id: `admin-${idCounter++}`, a, b: null, estado: 'OK', tipoMovimiento: a.tipoMovimiento });
            } else {
              let matchedIndex = -1;
              for (let j = 0; j < rowsB.length; j++) {
                if (matchedBIdx.has(j)) continue;
                const b = rowsB[j];
                if (a.usuario === b.usuario && Math.abs(a.monto - b.monto) < 0.01) {
                  matchedIndex = j;
                  break;
                }
              }

              if (matchedIndex >= 0) {
                matchedBIdx.add(matchedIndex);
                newPairs.push({ id: `match-${idCounter++}`, a, b: rowsB[matchedIndex], estado: 'OK', tipoMovimiento: a.tipoMovimiento });
              } else {
                newPairs.push({ id: `a-miss-${idCounter++}`, a, b: null, estado: 'MISSING_CHUNIOR', tipoMovimiento: a.tipoMovimiento });
              }
            }
          });

          // Remaining B
          for (let j = 0; j < rowsB.length; j++) {
            if (!matchedBIdx.has(j)) {
              newPairs.push({ id: `b-miss-${j}`, a: null, b: rowsB[j], estado: 'MISSING_AGENT', tipoMovimiento: rowsB[j].tipoMovimiento });
            }
          }

          newPairs.sort((x, y) => {
            const dx = x.a?.fechaObj || x.b?.fechaObj; 
            const dy = y.a?.fechaObj || y.b?.fechaObj;
            return (dx?.getTime() || 0) - (dy?.getTime() || 0);
          });

          setPairs(newPairs);
          setIsProcessing(false);
        };

        const filteredPairs = useMemo(() => {
          return pairs.filter(p => {
            const a = p.a;
            const b = p.b;

            if (filters.fecha !== '__ALL') {
              const d = a?.fechaObj || b?.fechaObj;
              if (!d || formatDateStr(d) !== filters.fecha) return false;
            }
            if (filters.agente !== '__ALL' && (!a || a.etiqueta !== filters.agente)) return false;
            if (filters.operador !== '__ALL' && (!b || b.operador !== filters.operador)) return false;
            if (filters.billetera !== '__ALL' && (!b || b.medio !== filters.billetera)) return false;
            if (filters.turno !== '__ALL' && (a?.turno || b?.turno || '') !== filters.turno) return false;
            if (filters.estado !== '__ALL') {
              if (a?.isAdminCharge) return filters.estado === 'OK';
              return p.estado === filters.estado;
            }
            if (filters.movimiento !== '__ALL' && p.tipoMovimiento !== filters.movimiento) return false;

            return true;
          });
        }, [pairs, filters]);

        const summary = useMemo(() => {
          const visible = filteredPairs.filter(p => !ignoredIds.has(p.id));
          let aTotal = 0, bTotal = 0, aIncome = 0, bIncome = 0, aOutcome = 0, bOutcome = 0, adminTotal = 0;
          let pairedCount = 0, missingCount = 0;

          visible.forEach(p => {
            if (p.a) {
              if (p.a.isAdminCharge) { adminTotal += p.a.monto; }
              else {
                aTotal += p.a.monto;
                p.a.monto >= 0 ? aIncome += p.a.monto : aOutcome += p.a.monto;
              }
            }
            if (p.b) {
              bTotal += p.b.monto;
              p.b.monto >= 0 ? bIncome += p.b.monto : bOutcome += p.b.monto;
            }
            
            if (!p.a?.isAdminCharge) {
              if (p.estado === 'OK' || p.estado === 'MANUAL') pairedCount++;
              else missingCount++;
            }
          });

          return { aTotal, bTotal, aIncome, bIncome, aOutcome, bOutcome, adminTotal, pairedCount, missingCount, totalVisible: filteredPairs.length };
        }, [filteredPairs, ignoredIds]);

        const filterOptions = useMemo(() => {
          // Cascading Logic: Options depend on the *current filtered list*, allowing re-selection of the field itself.
          
          const getOptions = (field, itemAccessor) => {
             const relevantPairs = pairs.filter(p => {
                const a = p.a; const b = p.b;
                // Check all filters except 'field'
                if (field !== 'fecha' && filters.fecha !== '__ALL') { const d = a?.fechaObj || b?.fechaObj; if (!d || formatDateStr(d) !== filters.fecha) return false; }
                if (field !== 'agente' && filters.agente !== '__ALL' && (!a || a.etiqueta !== filters.agente)) return false;
                if (field !== 'operador' && filters.operador !== '__ALL' && (!b || b.operador !== filters.operador)) return false;
                if (field !== 'billetera' && filters.billetera !== '__ALL' && (!b || b.medio !== filters.billetera)) return false;
                if (field !== 'turno' && filters.turno !== '__ALL' && (a?.turno || b?.turno || '') !== filters.turno) return false;
                if (field !== 'estado' && filters.estado !== '__ALL') { 
                    if (a?.isAdminCharge) { if (filters.estado !== 'OK') return false; }
                    else if (p.estado !== filters.estado) return false;
                }
                if (field !== 'movimiento' && filters.movimiento !== '__ALL' && p.tipoMovimiento !== filters.movimiento) return false;
                return true;
             });
             
             const set = new Set();
             relevantPairs.forEach(p => {
               const val = itemAccessor(p);
               if (val) set.add(val);
             });
             return set;
          };

          return {
            dates: getOptions('fecha', p => { const d = p.a?.fechaObj || p.b?.fechaObj; return d ? formatDateStr(d) : null; }),
            etiquetas: getOptions('agente', p => p.a?.etiqueta),
            operadores: getOptions('operador', p => p.b?.operador),
            medios: getOptions('billetera', p => p.b?.medio),
          };
        }, [pairs, filters]);

        const handleToggleIgnore = (id) => {
          const newSet = new Set(ignoredIds);
          if (newSet.has(id)) newSet.delete(id);
          else newSet.add(id);
          setIgnoredIds(newSet);
        };

        const handleEditSave = (updated) => {
          setPairs(prev => prev.map(p => p.id === updated.id ? updated : p));
          setEditModalOpen(false);
        };

        const handleLink = (baseId, targetId) => {
          setPairs(prev => {
            const baseIdx = prev.findIndex(p => p.id === baseId);
            const targetIdx = prev.findIndex(p => p.id === targetId);
            if (baseIdx === -1 || targetIdx === -1) return prev;

            const base = prev[baseIdx];
            const target = prev[targetIdx];

            const newPair = {
              id: `link-${Date.now()}`,
              a: base.a || target.a,
              b: base.b || target.b,
              estado: 'MANUAL',
              tipoMovimiento: base.tipoMovimiento || target.tipoMovimiento,
              manualPairId: `${baseId}|${targetId}`
            };

            const newArr = prev.filter(p => p.id !== baseId && p.id !== targetId);
            newArr.push(newPair);
            
            return newArr.sort((x, y) => {
              const dx = x.a?.fechaObj || x.b?.fechaObj; 
              const dy = y.a?.fechaObj || y.b?.fechaObj;
              return (dx?.getTime() || 0) - (dy?.getTime() || 0);
            });
          });
          setLinkModalOpen(false);
        };

        const totalMissing = pairs.filter(p => (p.estado === 'MISSING_AGENT' || p.estado === 'MISSING_CHUNIOR') && !ignoredIds.has(p.id)).length;

        const downloadCSV = () => {
          const headers = ['ETIQUETA_A','TURNO','HORA_A','USUARIO_A','MONTO_A','HORA_B','USUARIO_B','MONTO_B','OPERADOR','MEDIO','ESTADO','TIPO_MOVIMIENTO'];
          const rows = filteredPairs.filter(p => !ignoredIds.has(p.id)).map(p => {
             const a = p.a; const b = p.b;
             return [
               a?.etiqueta?.toUpperCase() || '',
               a?.turno || b?.turno || '',
               a?.fechaObj?.toISOString() || '',
               a?.isAdminCharge ? 'AJUSTE' : (a?.usuario || ''),
               a?.monto?.toFixed(2) || '',
               b?.fechaObj?.toISOString() || '',
               b?.usuario || '',
               b?.monto?.toFixed(2) || '',
               b?.operador?.toUpperCase() || '',
               b?.medio || '',
               a?.isAdminCharge ? 'AJUSTE' : p.estado,
               p.tipoMovimiento
             ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
          });
          
          const csvContent = [headers.join(','), ...rows].join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `comparacion_${new Date().toISOString().slice(0,10)}.csv`;
          link.click();
        };

        const copyToClipboard = () => {
          const rows = filteredPairs.filter(p => !ignoredIds.has(p.id)).map(p => {
             const a = p.a; const b = p.b;
             return [
               a?.etiqueta?.toUpperCase() || '',
               a?.turno || b?.turno || '',
               formatTime(a?.fechaObj),
               a?.isAdminCharge ? 'AJUSTE' : (a?.usuario || ''),
               a?.monto?.toLocaleString('es-AR') || '',
               formatTime(b?.fechaObj),
               b?.usuario || '',
               b?.monto?.toLocaleString('es-AR') || '',
               b?.operador?.toUpperCase() || '',
               b?.medio || '',
               a?.isAdminCharge ? 'AJUSTE' : p.estado,
               p.tipoMovimiento
             ].join('\t');
          });
          const content = rows.join('\n');
          navigator.clipboard.writeText(content).then(() => alert('Copiado al portapapeles!'));
        };

        // Container logic
        const resultsContainerClass = tableFullscreen 
          ? "fixed inset-0 z-50 bg-[#111418] flex flex-col animate-fade-in"
          : "animate-slide-up relative bg-[#1A1E23] rounded-xl border border-[#2A2A2A] shadow-lg flex flex-col p-4";

        return (
          <div className="min-h-screen p-4 md:p-6 pb-20 max-w-[1600px] mx-auto animate-fade-in relative">
            <div className="flex justify-between items-center mb-6 animate-slide-up">
              <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-[#8C6CFF]">
                Dif ‚Ä¢ Comparador agentes - chunior
              </h1>
            </div>

            <div className="bg-[#1A1E23] rounded-xl border border-[#2A2A2A] shadow-2xl p-6 mb-6 animate-slide-up">
              <div className="flex flex-col lg:flex-row gap-6">
                <div className="flex-1 min-w-[280px]">
                  <label className="block text-[#A8A8A8] text-sm font-medium mb-2">1. Cargar CSV(s) extraido de agentes/sub-agentes</label>
                  <div className="relative group">
                    <input 
                      type="file" 
                      multiple 
                      accept=".csv"
                      onChange={(e) => setAgentFiles(e.target.files)}
                      className="w-full bg-[#1E2329]/50 border border-[#2A2A2A] rounded-lg p-3 text-sm text-[#CCCCCC] file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-[#24364A] file:text-white hover:file:bg-[#1F3A5F] transition-all cursor-pointer hover:border-[#24364A]"
                    />
                  </div>
                  <p className="text-xs text-[#555] mt-2">Pod√©s seleccionar varios archivos. Renombr√° con criterio (ej: pc1, pc2).</p>
                </div>

                <div className="flex-1 min-w-[300px]">
                  <label className="block text-[#A8A8A8] text-sm font-medium mb-2">2. Pegar texto desde chunior</label>
                  <textarea 
                    value={chuniorText}
                    onChange={(e) => setChuniorText(e.target.value)}
                    placeholder="Pega aqu√≠ las l√≠neas copiadas desde chunior..."
                    className="w-full h-[120px] bg-[#1E2329]/50 border border-[#2A2A2A] rounded-lg p-3 text-sm text-white resize-none focus:border-[#24364A] focus:outline-none transition-colors custom-scrollbar"
                  />
                </div>

                <div className="w-full lg:w-[240px] flex flex-col gap-3 justify-end">
                  <button 
                    onClick={processData}
                    disabled={isProcessing || (!agentFiles && !chuniorText)}
                    className="w-full bg-gradient-to-r from-[#C7F24A] to-[#D4FF4A] text-[#0D1117] font-bold py-3 rounded-xl shadow-[0_8px_18px_rgba(199,242,74,0.15)] hover:translate-y-[-2px] hover:shadow-[0_12px_26px_rgba(199,242,74,0.25)] active:translate-y-0 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
                  >
                    {isProcessing ? 'Procesando...' : 'Procesar y comparar'}
                  </button>
                  <div className="flex gap-2">
                    <button onClick={downloadCSV} disabled={pairs.length === 0} className="flex-1 bg-[#24364A] hover:bg-[#1F3A5F] text-[#EAF2FF] py-2 rounded-lg text-sm font-medium transition-colors flex justify-center items-center gap-2 disabled:opacity-50">
                      <Download size={16} /> CSV
                    </button>
                    <button onClick={copyToClipboard} disabled={pairs.length === 0} className="flex-1 bg-[#24364A] hover:bg-[#1F3A5F] text-[#EAF2FF] py-2 rounded-lg text-sm font-medium transition-colors flex justify-center items-center gap-2 disabled:opacity-50">
                      <Copy size={16} /> Excel
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {pairs.length > 0 && (
              <div className={resultsContainerClass}>
                
                {/* Maximize Button (Only in Normal mode) */}
                {!tableFullscreen && (
                  <button 
                    onClick={() => setTableFullscreen(true)} 
                    className="absolute top-4 right-4 p-2 text-gray-400 hover:text-white rounded-full bg-[#2A2F36] hover:bg-[#3A4048] transition-colors z-20 shadow-lg"
                    title="Pantalla completa"
                  >
                    <Maximize2 size={20} />
                  </button>
                )}

                {/* Summary Section */}
                {tableFullscreen ? (
                  // Fullscreen: Compact Bar
                  <div className="shrink-0 flex items-center justify-between p-3 border-b border-[#2A2A2A] bg-[#1A1E23]">
                    <div className="flex flex-wrap gap-2 overflow-x-auto items-center">
                       <CompactSummaryBadge label="Dif Total" value={summary.aTotal - summary.bTotal} type="diff" />
                       <CompactSummaryBadge label="Total A" value={summary.aTotal} type="neutral" />
                       <CompactSummaryBadge label="Total B" value={summary.bTotal} type="neutral" />
                       <div className="h-4 w-px bg-[#333] mx-1"></div>
                       <CompactSummaryBadge label="Ingresos A" value={summary.aIncome} type="neutral" />
                       <CompactSummaryBadge label="Ingresos B" value={summary.bIncome} type="neutral" />
                       <div className="h-4 w-px bg-[#333] mx-1"></div>
                       <CompactSummaryBadge label="Egresos A" value={summary.aOutcome} type="bad" />
                       <CompactSummaryBadge label="Egresos B" value={summary.bOutcome} type="bad" />
                       <div className="ml-2 flex items-center gap-2 px-2 text-xs text-[#777]">
                         <span>Visibles: {summary.totalVisible}</span>
                         <span>Discrep: <span className="text-[#EF4444] font-bold">{summary.missingCount}</span></span>
                       </div>
                    </div>
                    <button 
                      onClick={() => setTableFullscreen(false)} 
                      className="ml-3 p-2 text-gray-400 hover:text-white rounded-full bg-[#2A2F36] hover:bg-[#3A4048] transition-colors shadow-lg shrink-0"
                      title="Salir de pantalla completa (ESC)"
                    >
                      <Minimize2 size={20} />
                    </button>
                  </div>
                ) : (
                  // Normal: Expanded Grid
                  <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6 p-2">
                    <SummaryBadge label="Total Agente" value={summary.aTotal} type="neutral" />
                    <SummaryBadge label="Total Chunior" value={summary.bTotal} type="neutral" />
                    <SummaryBadge label="Diferencia Total" value={summary.aTotal - summary.bTotal} type="diff" />
                    <SummaryBadge label="Cargas Admin" value={summary.adminTotal} type="warn" />
                    <div className="hidden lg:block"></div> 

                    <SummaryBadge label="Ingresos Agente" value={summary.aIncome} type="neutral" />
                    <SummaryBadge label="Ingresos Chunior" value={summary.bIncome} type="neutral" />
                    <SummaryBadge label="Dif. Ingresos" value={summary.aIncome - summary.bIncome} type="diff" />
                    <div className="hidden lg:block col-span-2"></div>

                    <SummaryBadge label="Egresos Agente" value={summary.aOutcome} type="bad" />
                    <SummaryBadge label="Egresos Chunior" value={summary.bOutcome} type="bad" />
                    <SummaryBadge label="Dif. Egresos" value={summary.aOutcome - summary.bOutcome} type="diff" />
                  </div>
                )}

                {/* Filters */}
                <div className={`shrink-0 flex flex-col lg:flex-row justify-between items-end gap-4 mb-4 pb-4 border-b border-[#2A2A2A] ${tableFullscreen ? 'px-4 pt-2' : ''}`}>
                  <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 w-full">
                     <SelectFilter label="Fecha" value={filters.fecha} options={Array.from(filterOptions.dates)} onChange={v => setFilters({...filters, fecha: v})} />
                     <SelectFilter label="Agente" value={filters.agente} options={Array.from(filterOptions.etiquetas)} onChange={v => setFilters({...filters, agente: v})} />
                     <SelectFilter label="Operador" value={filters.operador} options={Array.from(filterOptions.operadores)} onChange={v => setFilters({...filters, operador: v})} />
                     <SelectFilter label="Billetera" value={filters.billetera} options={Array.from(filterOptions.medios)} onChange={v => setFilters({...filters, billetera: v})} />
                     <SelectFilter label="Turno" value={filters.turno} options={['TM','TT','TN']} onChange={v => setFilters({...filters, turno: v})} />
                     <SelectFilter label="Estado" value={filters.estado} options={['OK','MISSING_CHUNIOR','MISSING_AGENT', 'MANUAL']} onChange={v => setFilters({...filters, estado: v})} />
                     <SelectFilter label="Tipo" value={filters.movimiento} options={['INGRESO','EGRESO']} onChange={v => setFilters({...filters, movimiento: v})} />
                  </div>
                  {!tableFullscreen && (
                    <div className="text-right min-w-[140px] text-sm space-y-1">
                      <div className="text-[#A8A8A8]">Visibles: <span className="text-white">{summary.totalVisible}</span></div>
                      <div>Emparejados: <strong className="text-[#9EE759]">{summary.pairedCount}</strong></div>
                      <div>Discrepancias: <strong className="text-[#EF4444]">{summary.missingCount}</strong></div>
                    </div>
                  )}
                </div>

                {/* Table Container */}
                <div className={`overflow-x-auto rounded-lg border border-[#2A2A2A] bg-[#1E2329] custom-scrollbar shadow-inner relative flex-1 ${tableFullscreen ? 'overflow-y-auto mb-4 mx-4' : 'max-h-[60vh] overflow-y-auto'}`}>
                  <table className="w-full text-sm text-left border-collapse relative">
                    <thead className="sticky top-0 bg-[#1E2329]/95 backdrop-blur-md z-10 text-[#CCCCCC] font-semibold text-xs uppercase tracking-wider shadow-sm">
                      <tr>
                        <th className="p-3 border-b border-[#2A2A2A]">Agente/Sub</th>
                        <th className="p-3 border-b border-[#2A2A2A]">Turno</th>
                        <th className="p-3 border-b border-[#2A2A2A]">Hora A</th>
                        <th className="p-3 border-b border-[#2A2A2A]">Usuario A</th>
                        <th className="p-3 border-b border-[#2A2A2A] text-right">Monto A</th>
                        <th className="p-3 border-b border-[#2A2A2A] border-l-2 border-l-[#2A2A2A]">Hora B</th>
                        <th className="p-3 border-b border-[#2A2A2A]">Usuario B</th>
                        <th className="p-3 border-b border-[#2A2A2A] text-right">Monto B</th>
                        <th className="p-3 border-b border-[#2A2A2A]">Operador</th>
                        <th className="p-3 border-b border-[#2A2A2A]">Billetera</th>
                        <th className="p-3 border-b border-[#2A2A2A]">Estado</th>
                        <th className="p-3 border-b border-[#2A2A2A] text-center w-[120px]">Acci√≥n</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredPairs.length === 0 ? (
                        <tr><td colSpan={12} className="p-8 text-center text-[#555]">No hay registros para mostrar.</td></tr>
                      ) : (
                        filteredPairs.map(p => {
                          const isIgnored = ignoredIds.has(p.id);
                          const isMatch = p.estado === 'OK' || p.estado === 'MANUAL' || p.a?.isAdminCharge;
                          const isMissA = p.estado === 'MISSING_AGENT';
                          
                          let rowClass = "hover:bg-[#24364A]/20 transition-colors border-b border-[#2A2A2A]/50";
                          if (isIgnored) rowClass += " opacity-50 bg-[#1A1E23] grayscale";
                          else if (p.a?.isAdminCharge) rowClass += ""; 
                          else if (isMatch) rowClass += ""; 
                          else if (isMissA) rowClass += " border-l-2 border-l-[#F59E0B] bg-[#F59E0B]/5"; 
                          else rowClass += " border-l-2 border-l-[#EF4444] bg-[#EF4444]/5"; 

                          return (
                            <tr key={p.id} className={rowClass}>
                              <td className="p-3">{p.a?.etiqueta?.toUpperCase()}</td>
                              <td className="p-3">{p.a?.turno || p.b?.turno}</td>
                              <td className="p-3 font-mono text-xs">{formatTime(p.a?.fechaObj)}</td>
                              <td className="p-3">{p.a?.isAdminCharge ? <span className="text-[#C7F24A] font-bold">AJUSTE</span> : p.a?.usuario}</td>
                              <td className={`p-3 text-right font-mono font-bold ${(p.a?.monto || 0) < 0 ? 'text-[#EF4444]' : 'text-[#9EE759]'}`}>
                                {p.a ? `$ ${formatCurrency(p.a.monto)}` : ''}
                              </td>
                              
                              <td className="p-3 border-l-2 border-l-[#2A2A2A] font-mono text-xs">{formatTime(p.b?.fechaObj)}</td>
                              <td className="p-3">{p.b?.usuario}</td>
                              <td className={`p-3 text-right font-mono font-bold ${(p.b?.monto || 0) < 0 ? 'text-[#EF4444]' : 'text-[#9EE759]'}`}>
                                {p.b ? `$ ${formatCurrency(p.b.monto)}` : ''}
                              </td>
                              
                              <td className="p-3">{p.b?.operador?.toUpperCase()}</td>
                              <td className="p-3">{p.b?.medio}</td>
                              <td className="p-3">
                                {p.a?.isAdminCharge ? <span className="text-[#C7F24A] font-bold text-xs">‚úî AJUSTE</span> : 
                                 p.estado === 'OK' ? <span className="text-[#9EE759] font-bold text-xs">‚úî OK</span> :
                                 p.estado === 'MANUAL' ? <span className="text-[#7A5CFF] font-bold text-xs">‚úî MANUAL</span> :
                                 p.estado === 'MISSING_AGENT' ? <span className="text-[#F59E0B] font-extrabold text-xs">‚ùå FALTA A</span> :
                                 <span className="text-[#EF4444] font-extrabold text-xs">‚ùå FALTA B</span>}
                              </td>
                              <td className="p-3 text-center">
                                <div className="flex items-center justify-center gap-1">
                                   {!isIgnored && (
                                     <button 
                                       onClick={() => { setEditingPair(p); setEditModalOpen(true); }}
                                       className="p-1.5 rounded-md hover:bg-[#24364A] text-[#A8A8A8] hover:text-[#C7F24A] transition-colors"
                                       title="Editar"
                                     >
                                       <Edit2 size={14} />
                                     </button>
                                   )}

                                   {!isIgnored && !isMatch && totalMissing > 1 && (
                                     <button 
                                       onClick={() => { setLinkingBasePair(p); setLinkModalOpen(true); }}
                                       className="p-1.5 rounded-md hover:bg-[#24364A] text-[#A8A8A8] hover:text-[#7A5CFF] transition-colors"
                                       title="Enlazar"
                                     >
                                       <LinkIcon size={14} />
                                     </button>
                                   )}

                                   <button 
                                     onClick={() => handleToggleIgnore(p.id)}
                                     className={`p-1.5 rounded-md hover:bg-[#24364A] transition-colors ${isIgnored ? 'text-[#C7F24A]' : 'text-[#A8A8A8] hover:text-white'}`}
                                     title={isIgnored ? "Mostrar" : "Ignorar"}
                                   >
                                     {isIgnored ? <Eye size={14} /> : <EyeOff size={14} />}
                                   </button>
                                </div>
                              </td>
                            </tr>
                          );
                        })
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            <EditModal 
              isOpen={editModalOpen} 
              pair={editingPair} 
              onClose={() => setEditModalOpen(false)} 
              onSave={handleEditSave} 
            />
            
            <LinkModal 
              isOpen={linkModalOpen}
              basePair={linkingBasePair}
              allPairs={pairs}
              onClose={() => setLinkModalOpen(false)}
              onLink={handleLink}
            />
          </div>
        );
      }

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
